<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HR Portal - SPACE42</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: #000000;
            color: white;
            min-height: 100vh;
            position: relative;
            overflow-x: hidden;
        }

        /* Orb Background Container */
        #orb-background {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 0;
            opacity: 1;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
            position: relative;
            z-index: 1;
        }

        /* Orion Introduction Dialog */
        #orion-intro {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: transparent;
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 9998;
            opacity: 0;
            transition: opacity 1s ease-out;
        }

        #orion-intro.show {
            display: flex;
            opacity: 1;
        }

        #orion-intro.fade-out {
            opacity: 0;
            pointer-events: none;
        }

        /* Loader Wrapper */
        .loader-wrapper {
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 2rem;
            animation: dialogAppear 1.2s ease-out;
        }

        @keyframes dialogAppear {
            0% {
                transform: translateY(30px) scale(0.95);
                opacity: 0;
            }

            100% {
                transform: translateY(0) scale(1);
                opacity: 1;
            }
        }

        /* Animated Orb */
        .orion-orb {
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 400px;
            height: 400px;
            font-family: "Inter", sans-serif;
            font-size: 1.5em;
            font-weight: 400;
            color: white;
            border-radius: 50%;
            background-color: transparent;
            user-select: none;
        }

        .loader {
            display: none;
        }

        @keyframes loader-letter-anim {

            0%,
            100% {
                opacity: 0.4;
                transform: translateY(0);
            }

            20% {
                opacity: 1;
                transform: scale(1.15);
            }

            40% {
                opacity: 0.7;
                transform: translateY(0);
            }
        }

        /* Hello Text Cycling */
        .hello-text {
            font-size: 1.5em;
            font-weight: 400;
            color: white;
            z-index: 1;
            animation: hello-fade 1s ease-in-out;
            position: relative;
            top: -30px;
        }

        @keyframes hello-fade {
            0% {
                opacity: 0;
                transform: scale(0.8);
            }

            50% {
                opacity: 1;
                transform: scale(1.1);
            }

            100% {
                opacity: 1;
                transform: scale(1);
            }
        }

        /* Typewriter Text */
        .typewriter-text {
            font-size: 1.5rem;
            line-height: 1.8;
            color: rgba(255, 255, 255, 0.9);
            text-align: center;
            max-width: 600px;
            min-height: 60px;
            display: inline-block;
        }

        .typewriter-container {
            position: absolute;
            width: 80%;
            text-align: center;
            bottom: 35%;
            left: 50%;
            transform: translateX(-50%);
        }

        .typewriter-text {
            color: white;
            font-size: 1.1rem;
            font-weight: 400;
        }

        .orion-continue {
            position: absolute;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%);
            padding: 12px 40px;
            background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%);
            border: none;
            border-radius: 50px;
            color: white;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 10px 30px rgba(59, 130, 246, 0.3);
            z-index: 10;
        }

        .orion-continue:hover {
            transform: translateX(-50%) translateY(-2px);
            box-shadow: 0 15px 40px rgba(59, 130, 246, 0.5);
        }

        /* Login */
        #login-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 9997;
            opacity: 0;
            transition: opacity 0.8s ease-out;
        }

        #login-screen.show {
            display: flex;
            opacity: 1;
        }

        #login-screen.hidden {
            display: none;
        }

        .login-box {
            width: 380px;
            background: rgba(17, 24, 39, 1);
            border: 1px solid rgba(55, 65, 81, 1);
            border-radius: 1rem;
            padding: 2.5rem;
        }

        .login-box h2 {
            text-align: center;
            margin-bottom: 0.5rem;
        }

        .login-box .sub {
            color: rgba(255, 255, 255, 0.6);
            font-size: 0.9rem;
            text-align: center;
            margin-bottom: 1.5rem;
        }

        .login-box label {
            display: block;
            color: rgba(156, 163, 175, 1);
            font-size: 0.875rem;
            margin-bottom: 4px;
        }

        .login-box input {
            width: 100%;
            padding: 0.75rem 1rem;
            background: rgba(17, 24, 39, 1);
            border: 1px solid rgba(55, 65, 81, 1);
            border-radius: 0.5rem;
            color: white;
            margin-bottom: 1rem;
        }

        .login-box input:focus {
            outline: none;
            border-color: rgba(167, 139, 250, 1);
        }

        .login-box .sign {
            width: 100%;
            padding: 0.75rem;
            background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%);
            border: none;
            border-radius: 0.5rem;
            color: white;
            font-weight: 600;
            cursor: pointer;
            margin-top: 0.5rem;
        }

        .login-box .sign:hover {
            opacity: 0.95;
        }

        .login-error {
            color: #ef4444;
            font-size: 0.85rem;
            margin-top: 0.5rem;
            display: none;
        }

        /* Dashboard */
        #dashboard {
            display: none;
        }

        #dashboard.show {
            display: block;
        }

        .user-badge {
            position: fixed;
            top: 24px;
            right: 24px;
            padding: 10px 20px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 30px;
            font-size: 0.9rem;
            z-index: 50;
            backdrop-filter: blur(10px);
            cursor: pointer;
        }

        .user-badge:hover {
            background: rgba(255, 255, 255, 0.08);
        }

        .user-badge svg {
            width: 18px;
            height: 18px;
            color: #3b82f6;
            vertical-align: middle;
            margin-right: 6px;
        }

        /* Orion Greeting */
        .orion-greeting {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 24px;
            padding: 2rem;
            margin-bottom: 2rem;
            display: flex;
            align-items: center;
            gap: 1.5rem;
        }

        .orion-avatar {
            width: 64px;
            height: 64px;
            background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .orion-avatar svg {
            width: 32px;
            height: 32px;
            color: white;
        }

        .orion-greeting h1 {
            font-size: 1.5rem;
            margin-bottom: 0.25rem;
        }

        .orion-greeting p {
            color: rgba(255, 255, 255, 0.6);
            font-size: 0.95rem;
        }

        /* Jobs Section */
        .jobs-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .jobs-header h2 {
            font-size: 1.5rem;
        }

        .jobs-panels {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .job-panel {
            width: calc(33.333% - 0.67rem);
            min-width: 280px;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 1.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            color: inherit;
            display: block;
        }

        .job-panel:hover {
            transform: translateY(-4px);
            border-color: rgba(59, 130, 246, 0.4);
            box-shadow: 0 15px 40px rgba(59, 130, 246, 0.2);
        }

        .job-panel h3 {
            font-size: 1.1rem;
            margin-bottom: 0.5rem;
        }

        .job-panel .job-meta {
            color: rgba(255, 255, 255, 0.6);
            font-size: 0.85rem;
        }

        .add-job-btn {
            width: calc(33.333% - 0.67rem);
            min-width: 280px;
            min-height: 100px;
            background: rgba(59, 130, 246, 0.08);
            border: 2px dashed rgba(59, 130, 246, 0.4);
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 2rem;
            color: #60a5fa;
        }

        .add-job-btn:hover {
            background: rgba(59, 130, 246, 0.15);
            border-color: rgba(59, 130, 246, 0.6);
        }

        /* Job Detail (expanded) */
        .job-detail-section {
            margin-top: 2rem;
            padding-top: 2rem;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            display: none;
        }

        .job-detail-section.show {
            display: block;
        }

        .job-detail-section h3 {
            font-size: 1.5rem;
            margin-bottom: 1rem;
        }

        .job-detail-section .job-desc {
            color: rgba(255, 255, 255, 0.7);
            line-height: 1.6;
            margin-bottom: 1.5rem;
        }

        .applicants-btn {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.875rem 1.5rem;
            background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%);
            border: none;
            border-radius: 12px;
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .applicants-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(59, 130, 246, 0.4);
        }

        /* Applicants Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 200;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 2rem;
        }

        .modal-overlay.show {
            display: flex;
        }

        .modal-content {
            background: rgba(17, 24, 39, 0.98);
            border: 1px solid rgba(59, 130, 246, 0.3);
            border-radius: 24px;
            max-width: 700px;
            width: 100%;
            max-height: 85vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .modal-header {
            padding: 1.5rem 2rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 {
            font-size: 1.25rem;
        }

        .modal-close {
            background: none;
            border: none;
            color: rgba(255, 255, 255, 0.6);
            font-size: 1.5rem;
            cursor: pointer;
        }

        .modal-body {
            padding: 1.5rem 2rem;
            overflow-y: auto;
        }

        .applicant-rank {
            font-size: 0.75rem;
            font-weight: 700;
            color: #60a5fa;
            margin-right: 0.5rem;
        }

        .applicant-card {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 1.25rem;
            margin-bottom: 1rem;
        }

        .applicant-card h4 {
            font-size: 1rem;
            margin-bottom: 0.25rem;
        }

        .applicant-card .applicant-email {
            color: rgba(255, 255, 255, 0.6);
            font-size: 0.85rem;
            margin-bottom: 0.75rem;
        }

        .applicant-score {
            display: inline-block;
            padding: 0.25rem 0.6rem;
            background: rgba(34, 197, 94, 0.2);
            border-radius: 8px;
            font-size: 0.8rem;
            font-weight: 600;
            color: #4ade80;
            margin-bottom: 0.5rem;
        }

        .applicant-flags {
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.7);
            line-height: 1.5;
        }

        .applicant-flags strong {
            color: #60a5fa;
        }

        /* Add Job Modal */
        .add-job-form label {
            display: block;
            color: rgba(255, 255, 255, 0.8);
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
        }

        .add-job-form input,
        .add-job-form textarea {
            width: 100%;
            padding: 0.75rem;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 8px;
            color: white;
            margin-bottom: 1rem;
        }

        .add-job-form textarea {
            min-height: 100px;
            resize: vertical;
        }

        .modal-actions {
            display: flex;
            gap: 1rem;
            margin-top: 1rem;
        }

        .modal-actions button {
            padding: 0.75rem 1.5rem;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            border: none;
        }

        .btn-primary {
            background: linear-gradient(135deg, #3b82f6, #8b5cf6);
            color: white;
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }

        /* Tabs Navigation */
        .hr-tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 2rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .hr-tab {
            padding: 0.75rem 1.5rem;
            background: none;
            border: none;
            color: rgba(255, 255, 255, 0.6);
            font-size: 0.95rem;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
        }

        .hr-tab:hover {
            color: white;
        }

        .hr-tab.active {
            color: #60a5fa;
            border-bottom-color: #60a5fa;
        }

        .hr-tab-content {
            display: none;
        }

        .hr-tab-content.active {
            display: block;
        }

        /* Rejected CV Section */
        .filters-row {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            margin-bottom: 1.5rem;
            align-items: center;
        }

        .filters-row select {
            padding: 0.5rem 1rem;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 8px;
            color: white;
            font-size: 0.9rem;
        }

        .view-toggle {
            display: flex;
            gap: 0.25rem;
            margin-left: auto;
        }

        .view-toggle button {
            padding: 0.4rem 0.8rem;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 6px;
            color: rgba(255, 255, 255, 0.8);
            cursor: pointer;
            font-size: 0.85rem;
        }

        .view-toggle button.active {
            background: rgba(59, 130, 246, 0.3);
            border-color: #60a5fa;
            color: #60a5fa;
        }

        .talent-orbit-cards {
            display: grid;
            gap: 1rem;
        }

        .talent-orbit-cards.table-view {
            display: block;
        }

        .talent-orbit-cards.table-view .orbit-card {
            display: grid;
            grid-template-columns: 45px 70px 55px 1fr 140px 55px 1fr;
            align-items: center;
            gap: 1rem;
        }

        .orbit-card,
        .rejected-cv-card {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            padding: 1.25rem;
            transition: all 0.3s;
        }

        .orbit-card:hover,
        .rejected-cv-card:hover {
            border-color: rgba(59, 130, 246, 0.3);
        }

        .orbit-card .score-badge,
        .rejected-cv-card .score-badge {
            display: inline-block;
            padding: 0.35rem 0.7rem;
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.3), rgba(220, 38, 38, 0.2));
            border-radius: 10px;
            font-size: 0.9rem;
            font-weight: 700;
            color: #f87171;
            margin-bottom: 0.5rem;
        }

        .rejected-cv-card .score-badge.good {
            background: linear-gradient(135deg, rgba(34, 197, 94, 0.3), rgba(22, 163, 74, 0.2));
            color: #4ade80;
        }

        .rejection-reason {
            font-size: 0.85rem;
            color: rgba(255, 255, 255, 0.7);
            margin: 0.75rem 0;
            padding: 0.75rem;
            background: rgba(239, 68, 68, 0.08);
            border-radius: 8px;
            border-left: 3px solid #ef4444;
        }

        .rejection-reason.collapsed {
            display: none;
        }

        .rejection-toggle {
            font-size: 0.8rem;
            color: #60a5fa;
            cursor: pointer;
            margin-top: 0.5rem;
        }

        .skill-gap-panel {
            margin-top: 1rem;
            padding: 1rem;
            background: rgba(59, 130, 246, 0.05);
            border-radius: 10px;
            border: 1px solid rgba(59, 130, 246, 0.2);
            font-size: 0.85rem;
        }

        .skill-gap-panel.collapsed {
            display: none;
        }

        .skill-match-bar {
            height: 6px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
            margin: 0.5rem 0;
            overflow: hidden;
        }

        .skill-match-fill {
            height: 100%;
            background: linear-gradient(90deg, #3b82f6, #8b5cf6);
            border-radius: 3px;
        }

        .skill-gaps {
            color: #f87171;
            margin-top: 0.5rem;
        }

        .training-potential {
            color: #4ade80;
            margin-top: 0.5rem;
            font-style: italic;
        }

        .reconsider-btn {
            padding: 0.5rem 1rem;
            background: linear-gradient(135deg, #3b82f6, #8b5cf6);
            border: none;
            border-radius: 10px;
            color: white;
            font-weight: 600;
            font-size: 0.85rem;
            cursor: pointer;
            margin-top: 0.75rem;
        }

        .reconsider-btn:hover {
            opacity: 0.95;
            transform: translateY(-1px);
        }

        /* Talent Orbit */
        .talent-orbit-intro {
            margin-bottom: 1.5rem;
        }

        .talent-orbit-section-title {
            font-size: 1.25rem;
            font-weight: 700;
            color: #60a5fa;
            margin-bottom: 0.5rem;
        }

        .talent-orbit-section-desc {
            color: rgba(255, 255, 255, 0.6);
            font-size: 0.9rem;
        }

        .orbit-legend {
            font-size: 0.85rem;
            color: rgba(255, 255, 255, 0.7);
            margin-bottom: 1.5rem;
            padding: 1rem;
            background: rgba(59, 130, 246, 0.06);
            border-radius: 12px;
            border: 1px solid rgba(59, 130, 246, 0.15);
            line-height: 1.8;
        }

        .orbit-badge {
            display: inline-block;
            padding: 0.2rem 0.5rem;
            border-radius: 6px;
            font-weight: 700;
            font-size: 0.75rem;
            margin-right: 0.5rem;
            margin-left: 0.25rem;
        }

        .orbit-badge.orbit-3 {
            background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
            color: white;
        }

        .orbit-badge.orbit-2 {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white;
        }

        .orbit-badge.orbit-1 {
            background: linear-gradient(135deg, #8b5cf6 0%, #6d28d9 100%);
            color: white;
        }

        .orbit-card .orbit-badge {
            margin-left: 0;
        }

        .rank-badge {
            display: inline-block;
            padding: 0.25rem 0.6rem;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            font-weight: 700;
            font-size: 0.9rem;
            color: #60a5fa;
            margin-bottom: 0.5rem;
        }

        .orbit-card-highlight {
            font-size: 0.8rem;
            color: #4ade80;
            margin-top: 0.5rem;
        }

        .talent-orbit-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 1rem;
        }

        .talent-group h4 {
            font-size: 0.95rem;
            color: #60a5fa;
            margin-bottom: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .talent-card {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 14px;
            padding: 1.25rem;
            margin-bottom: 1rem;
        }

        .talent-card:hover {
            border-color: rgba(59, 130, 246, 0.3);
        }

        .recontact-btn {
            padding: 0.4rem 0.9rem;
            background: rgba(59, 130, 246, 0.2);
            border: 1px solid rgba(59, 130, 246, 0.4);
            border-radius: 8px;
            color: #60a5fa;
            font-size: 0.85rem;
            cursor: pointer;
            margin-top: 0.5rem;
        }

        .recontact-btn:hover {
            background: rgba(59, 130, 246, 0.3);
        }

        /* Reconsider Modal */
        .reconsider-actions {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            margin-top: 1rem;
        }

        .reconsider-actions button {
            padding: 0.75rem 1.25rem;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 10px;
            color: white;
            text-align: left;
            cursor: pointer;
            transition: all 0.2s;
        }

        .reconsider-actions button:hover {
            background: rgba(59, 130, 246, 0.2);
            border-color: #60a5fa;
        }

        .reconsider-actions button.primary {
            background: linear-gradient(135deg, #3b82f6, #8b5cf6);
            border: none;
        }

        /* HR Chat Assistant */
        .hr-chat-toggle {
            position: fixed;
            bottom: 24px;
            right: 24px;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: linear-gradient(135deg, #3b82f6, #8b5cf6);
            border: none;
            color: white;
            cursor: pointer;
            z-index: 100;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 20px rgba(59, 130, 246, 0.5);
            transition: all 0.3s;
        }

        .hr-chat-toggle:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 25px rgba(59, 130, 246, 0.6);
        }

        .hr-chat-toggle svg {
            width: 28px;
            height: 28px;
        }

        .hr-chat-panel {
            position: fixed;
            bottom: 90px;
            right: 24px;
            width: 380px;
            max-height: 480px;
            background: rgba(17, 24, 39, 0.98);
            border: 1px solid rgba(59, 130, 246, 0.3);
            border-radius: 20px;
            z-index: 99;
            display: none;
            flex-direction: column;
            overflow: hidden;
            backdrop-filter: blur(20px);
        }

        .hr-chat-panel.open {
            display: flex;
        }

        .hr-chat-header {
            padding: 1rem 1.25rem;
            background: rgba(59, 130, 246, 0.1);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .hr-chat-header h3 {
            font-size: 1rem;
        }

        .hr-chat-close {
            background: none;
            border: none;
            color: rgba(255, 255, 255, 0.7);
            cursor: pointer;
            font-size: 1.25rem;
        }

        .hr-chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
            max-height: 320px;
        }

        .hr-chat-msg {
            margin-bottom: 1rem;
            font-size: 0.9rem;
        }

        .hr-chat-msg.user {
            text-align: right;
        }

        .hr-chat-msg .bubble {
            display: inline-block;
            padding: 0.6rem 1rem;
            background: rgba(59, 130, 246, 0.2);
            border-radius: 12px;
            max-width: 90%;
        }

        .hr-chat-msg.user .bubble {
            background: linear-gradient(135deg, #3b82f6, #8b5cf6);
        }

        .hr-chat-input-wrap {
            padding: 1rem;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .hr-chat-input-wrap input {
            width: 100%;
            padding: 0.75rem 1rem;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 12px;
            color: white;
            font-size: 0.9rem;
        }

        @media (max-width: 768px) {

            .job-panel,
            .add-job-btn {
                width: 100%;
            }

            .hr-chat-panel {
                width: calc(100% - 48px);
                right: 24px;
                left: 24px;
            }
        }
    </style>
</head>

<body>
    <div id="orb-background"></div>

    <!-- Orion Introduction -->
    <div id="orion-intro">
        <div class="loader-wrapper">
            <div class="orion-orb">
                <span class="hello-text" id="helloText"></span>
                <div class="loader"></div>
                <div class="typewriter-container">
                    <div class="typewriter-text" id="typewriterText"></div>
                </div>
                <button class="orion-continue" onclick="proceedToLogin()">Continue</button>
            </div>
        </div>
    </div>

    <!-- Login -->
    <div id="login-screen">
        <div class="login-box">
            <h2>HR Portal</h2>
            <p class="sub">Sign in with your SPACE42 company email</p>
            <form id="loginForm">
                <label>Company Email</label>
                <input type="email" id="loginEmail" placeholder="name@space42.com" required>
                <label>Password</label>
                <input type="password" id="loginPassword" placeholder="Enter password" required>
                <p class="login-error" id="loginError">Please use your @space42.com company email.</p>
                <button type="submit" class="sign">Sign In</button>
            </form>
        </div>
    </div>

    <!-- Dashboard -->
    <div id="dashboard">
        <div class="user-badge" id="userBadge"></div>

        <div class="container">
            <a href="index.html"
                style="color: rgba(255,255,255,0.7); text-decoration: none; font-size: 0.9rem; margin-bottom: 1rem; display: inline-block;">‚Üê
                Back to Career Portal</a>

            <!-- Tab Navigation -->
            <div class="hr-tabs">
                <button class="hr-tab active" data-tab="jobs">Open Positions</button>
                <button class="hr-tab" data-tab="interviews">Interviews</button>
                <button class="hr-tab" data-tab="talent">Talent Orbit</button>
            </div>

            <!-- Jobs Tab -->
            <div class="hr-tab-content active" id="tab-jobs">
            <!-- Orion Greeting -->
            <div class="orion-greeting">
                <div class="orion-avatar">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                            <rect x="5" y="2" width="14" height="10" rx="2" />
                            <circle cx="8.5" cy="7" r="1" />
                            <circle cx="15.5" cy="7" r="1" />
                            <path d="M9 11h6M5 12v4a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2v-4" />
                        </svg>
                </div>
                <div>
                    <h1 id="orionGreeting">Hello!</h1>
                    <p id="orionSub">Your hiring dashboard is ready. Click a job to view applicants.</p>
                </div>
            </div>

            <!-- Job Panels -->
            <div class="jobs-header">
                <h2>Open Positions</h2>
            </div>
            <div class="jobs-panels" id="jobsPanels"></div>

            <!-- Job Detail (shown when job clicked) -->
            <div class="job-detail-section" id="jobDetailSection">
                <h3 id="jobDetailTitle"></h3>
                    <div class="job-detail-meta" id="jobDetailMeta"
                        style="display:flex;gap:1rem;flex-wrap:wrap;margin-bottom:1rem;font-size:0.9rem;color:rgba(255,255,255,0.7);">
                        <span id="jobDetailDept"></span>
                        <span id="jobDetailLocation"></span>
                        <span id="jobDetailWorkType"></span>
                    </div>
                <p class="job-desc" id="jobDetailDesc"></p>

                    <div class="job-detail-grid"
                        style="display:grid;grid-template-columns:1fr 1fr;gap:1.5rem;margin:1.5rem 0;">
                        <div class="job-detail-box"
                            style="background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.1);border-radius:12px;padding:1rem;">
                            <h4 style="font-size:0.85rem;color:rgba(255,255,255,0.5);margin-bottom:0.5rem;">Experience
                                Required</h4>
                            <p id="jobDetailExperience" style="font-size:1rem;margin:0;">-</p>
                        </div>
                        <div class="job-detail-box"
                            style="background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.1);border-radius:12px;padding:1rem;">
                            <h4 style="font-size:0.85rem;color:rgba(255,255,255,0.5);margin-bottom:0.5rem;">Salary Range
                            </h4>
                            <p id="jobDetailSalary" style="font-size:1rem;margin:0;">-</p>
                        </div>
                    </div>

                    <div class="job-skills-section" style="margin:1.5rem 0;">
                        <div style="margin-bottom:1rem;">
                            <h4 style="font-size:0.85rem;color:#ef4444;margin-bottom:0.5rem;">üî¥ Non-Negotiable Skills
                                (Required)</h4>
                            <div id="jobDetailNonNegotiable" style="display:flex;flex-wrap:wrap;gap:0.5rem;"></div>
                        </div>
                        <div>
                            <h4 style="font-size:0.85rem;color:#22c55e;margin-bottom:0.5rem;">üü¢ Preferred Skills
                                (Nice-to-have)</h4>
                            <div id="jobDetailPreferred" style="display:flex;flex-wrap:wrap;gap:0.5rem;"></div>
                        </div>
                    </div>

                    <div style="display:flex;gap:1rem;align-items:center;margin-top:1rem;">
                        <span id="jobDetailOpenings" style="font-size:0.9rem;color:rgba(255,255,255,0.6);"></span>
                    </div>

                <button class="applicants-btn" id="applicantsBtn">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2" />
                            <circle cx="9" cy="7" r="4" />
                            <path d="M23 21v-2a4 4 0 0 0-3-3.87" />
                            <path d="M16 3.13a4 4 0 0 1 0 7.75" />
                        </svg>
                    View Applicants
                </button>
            </div>
            </div><!-- /tab-jobs -->

            <!-- Interviews Tab -->
            <div class="hr-tab-content" id="tab-interviews">
                <div class="talent-orbit-intro">
                    <h3 class="talent-orbit-section-title">Interview Schedule</h3>
                    <p class="talent-orbit-section-desc">Manage and track all scheduled interviews across positions.</p>
                </div>
                
                <!-- Interview Stats -->
                <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem; margin-bottom: 2rem;">
                    <div style="background: rgba(59, 130, 246, 0.1); border: 1px solid rgba(59, 130, 246, 0.3); border-radius: 1rem; padding: 1.25rem; text-align: center;">
                        <div id="interviewsToday" style="font-size: 2rem; font-weight: 700; color: #60a5fa;">0</div>
                        <div style="font-size: 0.85rem; color: rgba(255,255,255,0.6);">Today</div>
                    </div>
                    <div style="background: rgba(139, 92, 246, 0.1); border: 1px solid rgba(139, 92, 246, 0.3); border-radius: 1rem; padding: 1.25rem; text-align: center;">
                        <div id="interviewsThisWeek" style="font-size: 2rem; font-weight: 700; color: #a78bfa;">0</div>
                        <div style="font-size: 0.85rem; color: rgba(255,255,255,0.6);">This Week</div>
                    </div>
                    <div style="background: rgba(34, 197, 94, 0.1); border: 1px solid rgba(34, 197, 94, 0.3); border-radius: 1rem; padding: 1.25rem; text-align: center;">
                        <div id="interviewsCompleted" style="font-size: 2rem; font-weight: 700; color: #22c55e;">0</div>
                        <div style="font-size: 0.85rem; color: rgba(255,255,255,0.6);">Completed</div>
                    </div>
                    <div style="background: rgba(251, 191, 36, 0.1); border: 1px solid rgba(251, 191, 36, 0.3); border-radius: 1rem; padding: 1.25rem; text-align: center;">
                        <div id="interviewsPending" style="font-size: 2rem; font-weight: 700; color: #fbbf24;">0</div>
                        <div style="font-size: 0.85rem; color: rgba(255,255,255,0.6);">Pending</div>
                    </div>
                </div>

                <!-- Upcoming Interviews List -->
                <div style="background: rgba(15, 23, 42, 0.6); border: 1px solid rgba(255,255,255,0.1); border-radius: 1rem; overflow: hidden;">
                    <div style="padding: 1rem 1.25rem; border-bottom: 1px solid rgba(255,255,255,0.1); display: flex; justify-content: space-between; align-items: center;">
                        <h4 style="margin: 0; font-size: 1rem; color: #f3f4f6;">Upcoming Interviews</h4>
                        <button onclick="refreshInterviews()" style="padding: 0.5rem 1rem; background: rgba(59, 130, 246, 0.2); border: 1px solid rgba(59, 130, 246, 0.4); color: #60a5fa; border-radius: 0.5rem; cursor: pointer; font-size: 0.85rem;">
                            üîÑ Refresh
                        </button>
                    </div>
                    <div id="interviewsList" style="padding: 1rem;">
                        <div style="text-align: center; padding: 2rem; color: rgba(255,255,255,0.5);">
                            <div style="font-size: 2rem; margin-bottom: 0.5rem;">üìÖ</div>
                            <p>No interviews scheduled yet.</p>
                            <p style="font-size: 0.85rem;">Schedule interviews from the applicant cards in Open Positions.</p>
                        </div>
                    </div>
                </div>
            </div><!-- /tab-interviews -->

            <!-- Talent Orbit Tab -->
            <div class="hr-tab-content" id="tab-talent">
                <div class="talent-orbit-intro">
                    <h3 class="talent-orbit-section-title">Talent Orbit</h3>
                    <p class="talent-orbit-section-desc">All candidates who did not proceed to hire, ranked by
                        potential. Orbit 3 (highest value) first ‚Äî fast-track re-entry candidates.</p>
                </div>
                <div class="orbit-legend">
                    <div><span class="orbit-badge orbit-3">Orbit 3</span> Passed 3 interviews ¬∑ Final round / role
                        closed ¬∑ Fast-track re-entry ¬∑ HR alert on skill update</div>
                    <div><span class="orbit-badge orbit-2">Orbit 2</span> Passed HR + 1‚Äì2 interviews ¬∑ Rejected: missing
                        tool, limited project experience, domain gap</div>
                    <div><span class="orbit-badge orbit-1">Orbit 1</span> Early potential ¬∑ CV passed ¬∑ Failed early
                        round (skill gaps, not fit)</div>
                </div>
                <div class="filters-row">
                    <select id="filterOrbit">
                        <option value="">All Orbits</option>
                        <option value="3">Orbit 3 only</option>
                        <option value="2">Orbit 2 only</option>
                        <option value="1">Orbit 1 only</option>
                    </select>
                    <select id="filterRole">
                        <option value="">All Roles</option>
                    </select>
                    <select id="filterSkills">
                        <option value="">Skills Match</option>
                        <option value="high">70%+</option>
                        <option value="mid">50-70%</option>
                        <option value="low">&lt;50%</option>
                    </select>
                    <select id="filterYoe">
                        <option value="">Years of Experience</option>
                        <option value="5+">5+ years</option>
                        <option value="3-5">3-5 years</option>
                        <option value="0-3">0-3 years</option>
                    </select>
                    <div class="view-toggle">
                        <button type="button" class="view-btn active" data-view="card">Cards</button>
                        <button type="button" class="view-btn" data-view="table">Table</button>
                    </div>
                </div>
                <div class="talent-orbit-cards" id="talentOrbitCards"></div>
            </div>
        </div>
    </div>

    <!-- Applicants Modal -->
    <div class="modal-overlay" id="applicantsModal">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <h2 id="applicantsModalTitle">Applicants</h2>
                <button class="modal-close" id="applicantsModalClose">&times;</button>
            </div>
            <!-- Select Top N Controls -->
            <div id="topNControls" style="padding: 1rem 1.5rem; background: rgba(34, 197, 94, 0.1); border-bottom: 1px solid rgba(34, 197, 94, 0.3); display: flex; align-items: center; gap: 1rem; flex-wrap: wrap;">
                <span style="color: #22c55e; font-weight: 600;">Quick Actions:</span>
                <div style="display: flex; align-items: center; gap: 0.5rem;">
                    <span style="color: rgba(255,255,255,0.7);">Shortlist top</span>
                    <input type="number" id="topNInput" min="1" max="100" value="3" style="width: 60px; padding: 0.5rem; background: rgba(15, 23, 42, 0.8); border: 1px solid rgba(34, 197, 94, 0.4); border-radius: 0.4rem; color: white; text-align: center; font-size: 1rem;">
                    <span style="color: rgba(255,255,255,0.7);">candidates</span>
                </div>
                <button id="shortlistTopNBtn" style="padding: 0.5rem 1rem; background: linear-gradient(135deg, #22c55e, #16a34a); border: none; border-radius: 0.5rem; color: white; font-weight: 600; cursor: pointer; transition: all 0.3s;">
                    ‚úì Shortlist Top
                </button>
                <button id="rejectRestBtn" style="padding: 0.5rem 1rem; background: rgba(239, 68, 68, 0.2); border: 1px solid rgba(239, 68, 68, 0.4); border-radius: 0.5rem; color: #ef4444; font-weight: 500; cursor: pointer; transition: all 0.3s;">
                    ‚úó Reject Others
                </button>
            </div>
            <div class="modal-body" id="applicantsList" style="max-height: 60vh; overflow-y: auto;"></div>
        </div>
    </div>

    <!-- Reconsider Modal -->
    <div class="modal-overlay" id="reconsiderModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="reconsiderModalTitle">Reconsider Candidate</h2>
                <button class="modal-close" id="reconsiderModalClose">&times;</button>
            </div>
            <div class="modal-body">
                <p id="reconsiderCandidateName" style="margin-bottom: 1rem;"></p>
                <div class="reconsider-actions">
                    <button type="button" class="primary" id="reconsiderMoveInterview">Move to Interview Stage</button>
                    <button type="button" class="orbit3-only" id="reconsiderRecontact" style="display:none">Re-contact
                        (Fast-track)</button>
                    <button type="button" id="reconsiderReconsider">Reconsider for this role</button>
                    <button type="button" id="reconsiderTagFuture">Tag for future roles</button>
                </div>
            </div>
        </div>
    </div>

    <!-- HR Notes Modal -->
    <div class="modal-overlay" id="notesModal">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h2 id="notesModalTitle">Interview Notes</h2>
                <button class="modal-close" id="notesModalClose">&times;</button>
            </div>
            <div class="modal-body">
                <div id="notesCandidateInfo" style="padding: 1rem; background: rgba(59, 130, 246, 0.1); border-radius: 0.75rem; margin-bottom: 1.5rem;">
                    <h4 id="notesCandidateName" style="margin: 0 0 0.25rem 0;"></h4>
                    <span id="notesCandidateEmail" style="color: rgba(255,255,255,0.6); font-size: 0.9rem;"></span>
                </div>
                
                <!-- Existing Notes -->
                <div id="existingNotes" style="margin-bottom: 1.5rem; max-height: 200px; overflow-y: auto;"></div>
                
                <!-- Add New Note Form -->
                <form id="addNoteForm" style="background: rgba(15, 23, 42, 0.8); border: 1px solid rgba(59, 130, 246, 0.3); border-radius: 0.75rem; padding: 1.25rem;">
                    <h4 style="margin: 0 0 1rem 0; color: #60a5fa; font-size: 0.95rem;">Add Interview Note</h4>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                        <div>
                            <label style="display: block; font-size: 0.8rem; color: rgba(255,255,255,0.7); margin-bottom: 0.4rem;">Note Type</label>
                            <select id="noteFeedbackType" style="width: 100%; padding: 0.6rem; background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.2); border-radius: 0.4rem; color: white;">
                                <option value="interview">Interview</option>
                                <option value="screening">Phone Screening</option>
                                <option value="general">General Note</option>
                            </select>
                        </div>
                        <div>
                            <label style="display: block; font-size: 0.8rem; color: rgba(255,255,255,0.7); margin-bottom: 0.4rem;">Role Fit Score (1-10)</label>
                            <input type="number" id="noteRoleFitScore" min="1" max="10" placeholder="7" style="width: 100%; padding: 0.6rem; background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.2); border-radius: 0.4rem; color: white;">
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 1rem;">
                        <label style="display: block; font-size: 0.8rem; color: rgba(255,255,255,0.7); margin-bottom: 0.4rem;">Strengths</label>
                        <textarea id="noteStrengths" rows="2" placeholder="Key strengths observed..." style="width: 100%; padding: 0.6rem; background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.2); border-radius: 0.4rem; color: white; resize: vertical;"></textarea>
                    </div>
                    
                    <div style="margin-bottom: 1rem;">
                        <label style="display: block; font-size: 0.8rem; color: rgba(255,255,255,0.7); margin-bottom: 0.4rem;">Areas for Improvement / Weaknesses</label>
                        <textarea id="noteWeaknesses" rows="2" placeholder="Areas that need development..." style="width: 100%; padding: 0.6rem; background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.2); border-radius: 0.4rem; color: white; resize: vertical;"></textarea>
                    </div>
                    
                    <div style="margin-bottom: 1rem;">
                        <label style="display: block; font-size: 0.8rem; color: rgba(255,255,255,0.7); margin-bottom: 0.4rem;">Missing Skills / Requirements</label>
                        <textarea id="noteMissingReqs" rows="2" placeholder="Skills or qualifications the candidate is lacking..." style="width: 100%; padding: 0.6rem; background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.2); border-radius: 0.4rem; color: white; resize: vertical;"></textarea>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                        <div>
                            <label style="display: block; font-size: 0.8rem; color: rgba(255,255,255,0.7); margin-bottom: 0.4rem;">Recommendation</label>
                            <select id="noteRecommendation" style="width: 100%; padding: 0.6rem; background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.2); border-radius: 0.4rem; color: white;">
                                <option value="">Select...</option>
                                <option value="hire">Strong Hire</option>
                                <option value="maybe">Maybe / Needs More Info</option>
                                <option value="reject">Reject</option>
                            </select>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 1rem;">
                        <label style="display: block; font-size: 0.8rem; color: rgba(255,255,255,0.7); margin-bottom: 0.4rem;">Additional Notes</label>
                        <textarea id="noteAdditional" rows="3" placeholder="Any other observations, concerns, or follow-up items..." style="width: 100%; padding: 0.6rem; background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.2); border-radius: 0.4rem; color: white; resize: vertical;"></textarea>
                    </div>
                    
                    <div style="display: flex; justify-content: flex-end; gap: 0.75rem;">
                        <button type="button" id="cancelNoteBtn" style="padding: 0.6rem 1.25rem; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 0.5rem; color: white; cursor: pointer;">Cancel</button>
                        <button type="submit" style="padding: 0.6rem 1.25rem; background: linear-gradient(135deg, #3b82f6, #8b5cf6); border: none; border-radius: 0.5rem; color: white; cursor: pointer; font-weight: 500;">Save Note</button>
                    </div>
                </form>
                
                <p style="margin-top: 1rem; font-size: 0.8rem; color: rgba(255,255,255,0.5); text-align: center;">
                    üìß Notes on weaknesses and missing requirements will be used in personalized rejection emails.
                </p>
            </div>
        </div>
    </div>

    <!-- HR Chat Assistant -->
    <button class="hr-chat-toggle" id="hrChatToggle" title="HR Assistant" style="display:none" data-dashboard-only="1">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z" />
        </svg>
    </button>
    <div class="hr-chat-panel" id="hrChatPanel">
        <div class="hr-chat-header">
            <h3>Orion HR Assistant</h3>
            <button class="hr-chat-close" id="hrChatClose">&times;</button>
        </div>
        <div class="hr-chat-messages" id="hrChatMessages"></div>
        <div class="hr-chat-input-wrap" style="display: flex; gap: 0.5rem; align-items: center;">
            <input type="text" id="hrChatInput" style="flex: 1;"
                placeholder="Type or click mic to speak...">
            <!-- Voice button will be added by voice-chat.js -->
        </div>
    </div>
    
    <script src="voice-chat.js"></script>

    <!-- Add Job Modal -->
    <div class="modal-overlay" id="addJobModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Add New Position</h2>
                <button class="modal-close" id="addJobModalClose">&times;</button>
            </div>
            <div class="modal-body">
                <form class="add-job-form" id="addJobForm">
                    <label>Job Title</label>
                    <input type="text" id="newJobTitle" placeholder="e.g. Satellite Systems Engineer" required>
                    <label>Department</label>
                    <input type="text" id="newJobDepartment" placeholder="e.g. Engineering, Operations" required>
                    <label>Location</label>
                    <input type="text" id="newJobLocation" placeholder="e.g. Abu Dhabi, UAE">
                    <label>Description</label>
                    <textarea id="newJobDesc" placeholder="Job description..."></textarea>
                    <label>Non-Negotiable Skills <span
                            style="color:rgba(255,255,255,0.5);font-weight:normal;">(comma-separated,
                            required)</span></label>
                    <input type="text" id="newJobNonNegotiable" placeholder="e.g. Python, RF Engineering, C++">
                    <label>Preferred Skills <span
                            style="color:rgba(255,255,255,0.5);font-weight:normal;">(comma-separated,
                            nice-to-have)</span></label>
                    <input type="text" id="newJobPreferred" placeholder="e.g. React, AWS, Leadership">
                    <div class="modal-actions">
                        <button type="submit" class="btn-primary">Add Position</button>
                        <button type="button" class="btn-secondary" id="addJobCancel">Cancel</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="orb.js"></script>
    <script src="api.js"></script>
    <script>
        let jobs = [];
        let applications = [];
        let talentOrbit = [];
        let currentUser = null;
        let selectedJobId = null;

        // Check authentication on load (must be after variable declarations)
        if (api.token && api.user && api.user.user_type === 'hr') {
            currentUser = {
                email: api.user.email,
                name: api.user.email.split('@')[0].replace(/[._]/g, ' ').replace(/\b\w/g, l => l.toUpperCase())
            };
            // Defer showDashboard to DOMContentLoaded
            window.addEventListener('DOMContentLoaded', () => {
                showDashboard();
            });
        }

        // Sample talent orbit data (will be replaced by loadTalentOrbit from backend)
        // Talent Orbit ‚Äî all rejected candidates, grouped by orbit (3=highest value, 1=early potential)
        // Orbit 3: Passed 3 interviews, final round / role closed. Orbit 2: Passed HR + 1-2 interviews. Orbit 1: CV passed, failed early round.
        const sampleTalentOrbit = [
            { id: 1, orbit: 3, name: 'Aisha Al-Nuaimi', email: 'a.nuaimi@email.com', role: 'Satellite Systems Engineer', score: 94, skillsMatch: 91, yoe: '5+', education: 'high', reason: 'Strong hire, wrong timing ‚Äî role closed before offer. Passed all 3 interview stages.', requiredSkills: ['RF Engineering', 'Systems Integration', 'Payload'], candidateSkills: ['RF Engineering', 'Systems Integration', 'Payload'], skillMatchPct: 92, trainingPotential: 'Very high value. Fast-track re-entry. HR alert on skill update.', orbitHighlight: 'Fast-track re-entry ¬∑ HR alert on skill update' },
            { id: 2, orbit: 3, name: 'Thomas Weber', email: 't.weber@email.com', role: 'Satellite Systems Engineer', score: 90, skillsMatch: 88, yoe: '5+', education: 'high', reason: 'Final round rejection ‚Äî chosen candidate had slightly better satellite operations experience. Excellent technical fit.', requiredSkills: ['RF Engineering', 'Ground systems'], candidateSkills: ['RF Engineering', 'Ground systems'], skillMatchPct: 88, trainingPotential: 'Very high value. Fast-track for next Satellite role.', orbitHighlight: 'Fast-track re-entry ¬∑ HR alert on skill update' },
            { id: 3, orbit: 3, name: 'Fatima Khan', email: 'f.khan@email.com', role: 'Space Software Developer', score: 93, skillsMatch: 90, yoe: '3-5', education: 'high', reason: 'Role closed after final round. Passed 3 stages. Strong C++ and real-time experience.', requiredSkills: ['C++', 'Python', 'Real-time'], candidateSkills: ['C++', 'Python', 'Real-time'], skillMatchPct: 90, trainingPotential: 'Very high value. Fast-track for Software roles.', orbitHighlight: 'Fast-track re-entry ¬∑ HR alert on skill update' },
            { id: 4, orbit: 2, name: 'Elena Rodriguez', email: 'e.rodriguez@email.com', role: 'Mission Control Specialist', score: 82, skillsMatch: 78, yoe: '3-5', education: 'high', reason: 'Passed HR + 2 interviews. Rejected due to limited project experience with live mission ops tools.', requiredSkills: ['Real-time systems', 'Mission protocols', 'Ops tools'], candidateSkills: ['Mission protocols', 'Operations'], skillMatchPct: 72, trainingPotential: 'Missing tool experience ‚Äî 3-month onboarding could bridge gap.' },
            { id: 5, orbit: 2, name: 'James Wilson', email: 'j.wilson@email.com', role: 'Space Software Developer', score: 79, skillsMatch: 74, yoe: '3-5', education: 'mid', reason: 'Passed HR + 1 technical. Domain exposure gap ‚Äî no spacecraft software projects.', requiredSkills: ['C++', 'Flight software', 'Spacecraft'], candidateSkills: ['C++', 'Embedded'], skillMatchPct: 68, trainingPotential: 'Strong fundamentals. Consider for future with domain training.' },
            { id: 6, orbit: 1, name: 'Yusuf Al-Rashid', email: 'y.alrashid@email.com', role: 'Satellite Systems Engineer', score: 78, skillsMatch: 75, yoe: '3-5', education: 'high', reason: 'Passed CV screening. Failed early technical ‚Äî experience below requirement (5+ years preferred). Skill gaps, not fit.', requiredSkills: ['RF Engineering', 'Systems Integration'], candidateSkills: ['RF Engineering'], skillMatchPct: 67, trainingPotential: 'High training potential ‚Äî 2-year gap can be bridged.' },
            { id: 7, orbit: 1, name: 'Maria Santos', email: 'm.santos@email.com', role: 'Mission Control Specialist', score: 72, skillsMatch: 68, yoe: '0-3', education: 'mid', reason: 'Passed CV. Failed early HR/technical ‚Äî skill gap in real-time systems. Good academic background.', requiredSkills: ['Real-time systems', 'Operations'], candidateSkills: ['Operations'], skillMatchPct: 45, trainingPotential: 'Consider for junior mission ops ‚Äî shows aptitude.' },
            { id: 8, orbit: 1, name: 'Omar Hassan', email: 'o.hassan@email.com', role: 'Space Software Developer', score: 68, skillsMatch: 62, yoe: '3-5', education: 'high', reason: 'Passed CV. Failed early round ‚Äî role mismatch. Web dev background, not embedded/real-time.', requiredSkills: ['C++', 'Real-time', 'Embedded'], candidateSkills: ['Python', 'JavaScript'], skillMatchPct: 38, trainingPotential: '6-month C++/embedded training could bridge gap.' }
        ];

        // Sample applicants (ranked by resume flags, docs, interview notes)
        const applicantsData = {
            1: [
                { name: 'Sarah Chen', email: 'sarah.chen@email.com', score: 94, flags: 'Python, RF Engineering (resume) ‚Ä¢ Strong technical doc ‚Ä¢ Interview: leadership skills noted' },
                { name: 'Marcus Okonkwo', email: 'm.okonkwo@email.com', score: 88, flags: 'Embedded Systems, Systems Integration (resume) ‚Ä¢ Portfolio uploaded ‚Ä¢ Interview: problem-solving highlight' },
                { name: 'Elena Vasquez', email: 'e.vasquez@email.com', score: 82, flags: 'C++, Satellite comms (resume) ‚Ä¢ Reference letters ‚Ä¢ Interview: cultural fit strong' }
            ],
            2: [
                { name: 'James Wilson', email: 'j.wilson@email.com', score: 91, flags: 'Operations, Real-time systems (resume) ‚Ä¢ Certifications uploaded ‚Ä¢ Interview: mission-critical experience' },
                { name: 'Priya Sharma', email: 'p.sharma@email.com', score: 85, flags: 'Communication protocols (resume) ‚Ä¢ Project samples ‚Ä¢ Interview: team collaboration noted' }
            ],
            3: [
                { name: 'Alex Kim', email: 'a.kim@email.com', score: 96, flags: 'C++, Python, Real-time (resume) ‚Ä¢ GitHub portfolio ‚Ä¢ Interview: excellent technical depth' },
                { name: 'Nina Petrov', email: 'n.petrov@email.com', score: 89, flags: 'Software architecture (resume) ‚Ä¢ Design docs ‚Ä¢ Interview: spacecraft experience' }
            ]
        };

        // Initialize Orb Background
        let orb;
        window.addEventListener('DOMContentLoaded', () => {
            if (window.initOrb) {
                orb = window.initOrb('orb-background', {
                    hue: 0,
                    hoverIntensity: 2,
                    rotateOnHover: true,
                    forceHoverState: false,
                    backgroundColor: '#000000'
                });
            }
        });

        // Check existing session - handled in showDashboard() now

        // Orion Intro - Show on page load if not logged in
        const urlParams = new URLSearchParams(window.location.search);
        const isReturning = sessionStorage.getItem('hrReturningUser') === '1' || urlParams.get('skipIntro') === '1';

        if (!isReturning && !(api.token && api.user && api.user.user_type === 'hr')) {
            // Show Orion intro first
            setTimeout(() => {
                document.getElementById('orion-intro').classList.add('show');
                cycleHelloMessages();
                setTimeout(() => {
                    const typewriterElement = document.getElementById('typewriterText');
                    const greeting = "Hello! I'm Orion, your HR assistant at SPACE42.";
                    typeWriter(typewriterElement, greeting, 50);
                }, 500);
            }, 500);
        } else if (!(api.token && api.user && api.user.user_type === 'hr')) {
            // Skip intro, show login directly
            document.getElementById('login-screen').classList.add('show');
        }

        // Cycle through "Hello" in different languages
        function cycleHelloMessages() {
            const hellos = [
                'Hello',      // English
                'Hola',       // Spanish
                'Bonjour',    // French
                'Ciao',       // Italian
                'Hallo',      // German
                '„Åì„Çì„Å´„Å°„ÅØ',    // Japanese
                '‰Ω†Â•Ω',        // Chinese
                'ŸÖÿ±ÿ≠ÿ®ÿß',      // Arabic
                '–ü—Ä–∏–≤–µ—Ç',     // Russian
                'Ol√°'         // Portuguese
            ];

            const helloElement = document.getElementById('helloText');
            let currentIndex = 0;

            function updateHello() {
                helloElement.textContent = hellos[currentIndex];
                helloElement.style.animation = 'none';
                setTimeout(() => {
                    helloElement.style.animation = 'hello-fade 1s ease-in-out';
                }, 10);

                currentIndex = (currentIndex + 1) % hellos.length;
            }

            // Show first hello immediately
            updateHello();

            // Then cycle every 1.2 seconds
            setInterval(updateHello, 1200);
        }

        // Typewriter effect
        function typeWriter(element, text, speed = 50) {
            let i = 0;
            element.textContent = '';
            function type() {
                if (i < text.length) {
                    element.textContent += text.charAt(i);
                    i++;
                    setTimeout(type, speed);
                }
            }
            type();
        }

        function proceedToLogin() {
            document.getElementById('orion-intro').classList.add('fade-out');
            sessionStorage.setItem('hrReturningUser', '1');
            setTimeout(() => {
                document.getElementById('orion-intro').style.display = 'none';
                document.getElementById('login-screen').classList.add('show');
            }, 800);
        }

        // Login
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('loginEmail').value.trim();
            const password = document.getElementById('loginPassword').value;

            if (!email.toLowerCase().endsWith('@space42.com')) {
                document.getElementById('loginError').style.display = 'block';
                return;
            }
            document.getElementById('loginError').style.display = 'none';

            const submitBtn = e.target.querySelector('button[type="submit"]');
            const originalText = submitBtn.textContent;
            submitBtn.textContent = 'Signing in...';
            submitBtn.disabled = true;

            try {
                const result = await api.login(email, password);
                if (result.user_type !== 'hr') {
                    throw new Error('Access denied. HR portal requires HR account.');
                }
                currentUser = {
                    email: result.email,
                    name: email.split('@')[0].replace(/[._]/g, ' ').replace(/\b\w/g, l => l.toUpperCase())
                };
            showDashboard();
            } catch (error) {
                document.getElementById('loginError').textContent = error.message || 'Login failed. Please check your credentials.';
                document.getElementById('loginError').style.display = 'block';
                submitBtn.textContent = originalText;
                submitBtn.disabled = false;
            }
        });

        async function showDashboard() {
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('dashboard').classList.add('show');
            const chatToggle = document.getElementById('hrChatToggle');
            if (chatToggle) chatToggle.style.display = 'flex';
            document.getElementById('orionGreeting').textContent = `Hello, ${currentUser.name}!`;
            document.getElementById('userBadge').innerHTML = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg> ${currentUser.email}`;
            document.getElementById('userBadge').onclick = () => {
                window.location.href = 'hr-profile.html';
            };
            await loadJobs();
            await loadApplications();
            await loadTalentOrbit();
            renderJobs();
            initTabs();
            renderTalentOrbit();
            initHRChat();
        }

        async function loadJobs() {
            try {
                jobs = await api.getJobs();
            } catch (error) {
                console.error('Failed to load jobs:', error);
                alert('Failed to load jobs. Please try again.');
            }
        }

        async function loadApplications() {
            try {
                applications = await api.request('/applications', {
                    requireAuth: true,
                    method: 'GET'
                });
            } catch (error) {
                console.error('Failed to load applications:', error);
                applications = [];
            }
        }

        async function loadTalentOrbit() {
            try {
                // Get all rejected applications
                const rejectedApps = applications.filter(app => app.status === 'rejected');
                // Fetch candidate details for rejected applications
                talentOrbit = [];
                for (const app of rejectedApps) {
                    try {
                        const candidate = await api.getCandidate(app.candidate_id);
                        const job = jobs.find(j => j.id === app.job_role_id);
                        const matchedSkills = app.eligibility_details?.matched_skills || [];
                        talentOrbit.push({
                            id: app.id,
                            candidate_id: app.candidate_id,
                            name: `${candidate.first_name} ${candidate.last_name}`,
                            email: candidate.email,
                            role: job?.title || 'Unknown Role',
                            score: app.combined_score || app.technical_score || 0,
                            skillsMatch: matchedSkills.length,
                            yoe: candidate.years_of_experience ? `${candidate.years_of_experience}+` : 'N/A',
                            education: 'high', // Default, can be enhanced
                            reason: app.eligibility_details?.explanation || 'Rejected',
                            requiredSkills: job?.non_negotiable_skills || [],
                            candidateSkills: matchedSkills,
                            skillMatchPct: app.eligibility_details ?
                                Math.round((matchedSkills.length / (job?.non_negotiable_skills?.length || 1)) * 100) : 0,
                            trainingPotential: 'Review candidate profile for training potential.',
                            orbitHighlight: app.combined_score >= 85 ? 'Fast-track re-entry ¬∑ HR alert on skill update' : '',
                            application: app
                        });
                    } catch (err) {
                        console.warn('Failed to load candidate for app:', app.id, err);
                    }
                }
            } catch (error) {
                console.error('Failed to load talent orbit:', error);
                talentOrbit = [];
            }
        }

        function initTabs() {
            document.querySelectorAll('.hr-tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    document.querySelectorAll('.hr-tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.hr-tab-content').forEach(c => c.classList.remove('active'));
                    tab.classList.add('active');
                    document.getElementById('tab-' + tab.dataset.tab).classList.add('active');
                });
            });
        }

        function renderTalentOrbit() {
            // Update role filter dropdown with actual jobs
            const roleFilterEl = document.getElementById('filterRole');
            if (roleFilterEl && jobs.length > 0) {
                const currentValue = roleFilterEl.value;
                roleFilterEl.innerHTML = '<option value="">All Roles</option>' +
                    jobs.map(job => `<option value="${job.title}">${job.title}</option>`).join('');
                if (currentValue) roleFilterEl.value = currentValue;
            }

            const orbitFilter = document.getElementById('filterOrbit')?.value;
            const roleFilter = document.getElementById('filterRole')?.value;
            const skillsFilter = document.getElementById('filterSkills')?.value;
            const yoeFilter = document.getElementById('filterYoe')?.value;
            const isTableView = document.querySelector('.view-btn[data-view="table"]')?.classList.contains('active');

            // Determine orbit based on application status and scores
            // Orbit 3: High scores, interview_completed status
            // Orbit 2: Medium scores, shortlisted/interview_scheduled
            // Orbit 1: Lower scores, under_ai_review
            const assignOrbit = (app) => {
                const score = app.combined_score || app.technical_score || 0;
                if (app.status === 'interview_completed' && score >= 85) return 3;
                if ((app.status === 'shortlisted' || app.status === 'interview_scheduled') && score >= 75) return 2;
                return 1;
            };

            // Add orbit to talentOrbit data
            talentOrbit.forEach(item => {
                if (!item.orbit) {
                    item.orbit = assignOrbit(item.application || { status: 'rejected', combined_score: item.score });
                }
            });

            let filtered = talentOrbit.filter(r => {
                if (orbitFilter && r.orbit !== parseInt(orbitFilter)) return false;
                if (roleFilter && r.role !== roleFilter) return false;
                if (skillsFilter && (
                    (skillsFilter === 'high' && r.skillsMatch < 70) ||
                    (skillsFilter === 'mid' && (r.skillsMatch < 50 || r.skillsMatch >= 70)) ||
                    (skillsFilter === 'low' && r.skillsMatch >= 50)
                )) return false;
                return true;
            });

            filtered.sort((a, b) => {
                if (a.orbit !== b.orbit) return b.orbit - a.orbit;
                return b.score - a.score;
            });

            const list = document.getElementById('talentOrbitCards');
            if (!list) return;
            list.className = 'talent-orbit-cards' + (isTableView ? ' table-view' : '');
            list.innerHTML = filtered.map((r, idx) => {
                const rank = idx + 1;
                const scoreClass = r.score >= 75 ? 'good' : '';
                const gaps = (r.requiredSkills || []).filter(s => !(r.candidateSkills || []).includes(s));
                const orbitBadge = `<span class="orbit-badge orbit-${r.orbit}">Orbit ${r.orbit}</span>`;
                const rankBadge = `<span class="rank-badge">#${rank}</span>`;
                const orbitHighlight = r.orbit === 3 && r.orbitHighlight ? `<div class="orbit-card-highlight">${r.orbitHighlight}</div>` : '';

                if (isTableView) {
                    return `
                    <div class="orbit-card" data-id="${r.id}">
                        ${rankBadge}
                        ${orbitBadge}
                        <span class="score-badge ${scoreClass}">${r.score}%</span>
                        <div><strong>${r.name}</strong><br><span class="applicant-email">${r.email}</span></div>
                        <div style="font-size:0.85rem;">${r.role}</div>
                        <div style="font-size:0.85rem;">${r.skillMatchPct}%</div>
                        <div>
                            <span class="rejection-toggle" onclick="toggleRejectionReason(${r.id})">Reason</span> ¬∑
                            <span class="rejection-toggle" onclick="toggleSkillGap(${r.id})">Gaps</span>
                            ${r.orbit === 3 ? '<button class="recontact-btn" onclick="event.stopPropagation(); recontactCandidate(' + r.id + ')">Re-contact</button> ' : ''}
                            <button class="reconsider-btn" onclick="openReconsiderModal(${r.id})">Reconsider</button>
                        </div>
                        <div class="rejection-reason collapsed" id="reason-${r.id}" style="grid-column:1/-1">${r.reason}</div>
                        <div class="skill-gap-panel collapsed" id="gap-${r.id}" style="grid-column:1/-1">
                            <div>Match: ${r.skillMatchPct}%</div>
                            <div class="skill-match-bar"><div class="skill-match-fill" style="width:${r.skillMatchPct}%"></div></div>
                            <div class="skill-gaps">Missing: ${(gaps.length ? gaps.join(', ') : 'None')}</div>
                            <div class="training-potential">${r.trainingPotential}</div>
                        </div>
                    </div>
                `;
                }
                return `
                    <div class="orbit-card" data-id="${r.id}">
                        ${rankBadge}
                        ${orbitBadge}
                        <span class="score-badge ${scoreClass}">${r.score}%</span>
                        <h4>${r.name}</h4>
                        <div class="applicant-email">${r.email}</div>
                        <div style="font-size:0.85rem;color:rgba(255,255,255,0.6);margin-top:0.25rem;">${r.role} ¬∑ ${r.yoe} ¬∑ Edu: ${r.education}</div>
                        ${orbitHighlight}
                        <div class="rejection-toggle" onclick="toggleRejectionReason(${r.id})">View AI rejection reason ‚ñº</div>
                        <div class="rejection-reason collapsed" id="reason-${r.id}">${r.reason}</div>
                        <div class="rejection-toggle" onclick="toggleSkillGap(${r.id})">View skill gap analysis ‚ñº</div>
                        <div class="skill-gap-panel collapsed" id="gap-${r.id}">
                            <div>Match: ${r.skillMatchPct}%</div>
                            <div class="skill-match-bar"><div class="skill-match-fill" style="width:${r.skillMatchPct}%"></div></div>
                            <div class="skill-gaps">Missing: ${(gaps.length ? gaps.join(', ') : 'None')}</div>
                            <div class="training-potential">${r.trainingPotential}</div>
                        </div>
                        <div style="display:flex;gap:0.5rem;margin-top:0.75rem;flex-wrap:wrap;">
                            ${r.orbit === 3 ? '<button class="recontact-btn" onclick="recontactCandidate(' + r.id + ')">Re-contact</button>' : ''}
                            <button class="reconsider-btn" onclick="openReconsiderModal(' + r.id + ')">Reconsider</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function toggleRejectionReason(id) {
            const el = document.getElementById('reason-' + id);
            if (el) el.classList.toggle('collapsed');
        }

        function toggleSkillGap(id) {
            const el = document.getElementById('gap-' + id);
            if (el) el.classList.toggle('collapsed');
        }

        let reconsiderCandidateId = null;

        function openReconsiderModal(id) {
            const c = talentOrbit.find(r => r.id === id);
            if (!c) return;
            reconsiderCandidateId = id;
            document.getElementById('reconsiderModalTitle').textContent = 'Reconsider Candidate';
            document.getElementById('reconsiderCandidateName').textContent = `${c.name} (${c.email}) ‚Äî ${c.role}${c.orbit === 3 ? ' [Orbit 3 ‚Äî Fast-track]' : ''}`;
            const recontactBtn = document.getElementById('reconsiderRecontact');
            if (recontactBtn) recontactBtn.style.display = c.orbit === 3 ? 'block' : 'none';
            document.getElementById('reconsiderModal').classList.add('show');
        }

        document.getElementById('reconsiderModalClose')?.addEventListener('click', () => document.getElementById('reconsiderModal').classList.remove('show'));

        document.getElementById('reconsiderMoveInterview')?.addEventListener('click', async () => {
            if (!reconsiderCandidateId) return;
            const app = talentOrbit.find(r => r.id === reconsiderCandidateId)?.application;
            if (!app) return;
            try {
                await api.updateApplicationStatus(app.id, 'interview_scheduled', 'Moved to interview stage from reconsideration');
                alert('Candidate moved to interview stage.');
                document.getElementById('reconsiderModal').classList.remove('show');
                await loadApplications();
                await loadTalentOrbit();
                renderTalentOrbit();
            } catch (error) {
                alert('Failed to update status: ' + error.message);
            }
        });

        document.getElementById('reconsiderRecontact')?.addEventListener('click', async () => {
            if (!reconsiderCandidateId) return;
            const c = talentOrbit.find(r => r.id === reconsiderCandidateId);
            if (!c) return;
            // Re-contact doesn't change status, just logs action
            alert('Re-contact initiated for ' + (c?.name || 'candidate') + '. Fast-track re-entry.');
            document.getElementById('reconsiderModal').classList.remove('show');
        });

        document.getElementById('reconsiderReconsider')?.addEventListener('click', async () => {
            if (!reconsiderCandidateId) return;
            const app = talentOrbit.find(r => r.id === reconsiderCandidateId)?.application;
            if (!app) return;
            try {
                // Move back to shortlisted
                await api.updateApplicationStatus(app.id, 'shortlisted', 'Reconsidered for this role');
                alert('Candidate reconsidered for this role.');
                document.getElementById('reconsiderModal').classList.remove('show');
                await loadApplications();
                await loadTalentOrbit();
                renderTalentOrbit();
            } catch (error) {
                alert('Failed to update status: ' + error.message);
            }
        });

        document.getElementById('reconsiderTagFuture')?.addEventListener('click', () => {
            if (!reconsiderCandidateId) return;
            // Tagging doesn't change status, just logs action
            alert('Candidate tagged for future roles.');
            document.getElementById('reconsiderModal').classList.remove('show');
        });

        document.querySelectorAll('#filterOrbit, #filterRole, #filterSkills, #filterYoe, #filterEducation').forEach(el => {
            el?.addEventListener('change', renderTalentOrbit);
        });
        document.querySelectorAll('.view-btn').forEach(btn => {
            btn?.addEventListener('click', () => {
                document.querySelectorAll('.view-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                renderTalentOrbit();
            });
        });

        function initHRChat() {
            const toggle = document.getElementById('hrChatToggle');
            const panel = document.getElementById('hrChatPanel');
            const closeBtn = document.getElementById('hrChatClose');
            const input = document.getElementById('hrChatInput');
            const messages = document.getElementById('hrChatMessages');

            // Initialize Voice Chat for HR
            let hrVoiceChat = null;
            if (typeof initVoiceChatWidget === 'function') {
                hrVoiceChat = initVoiceChatWidget('hrChatInput', 'hrChatMessages', {
                    apiKey: 'VF.DM.697f067be3fe14c39580e132.p8qmZZk2CHACMe7v',
                    projectId: '697ec5f2f3b8565c0e66aac3'
                });
            }

            const hrResponses = {
                default: 'I can help with: "Summarize talent orbit for [role]", "Who almost made it?", "Orbit 3 candidates?"',
                summarize: (role) => {
                    const list = talentOrbit.filter(r => !role || r.role.includes(role)).slice(0, 5);
                    return `For ${role || 'that role'}: ${list.map(r => r.name + ' (Orbit ' + r.orbit + ', ' + r.score + '%)').join(', ') || 'None'}.`;
                },
                almost: () => `Orbit 3 (highest value): ${talentOrbit.filter(r => r.orbit === 3).map(r => r.name).join(', ') || 'None'}. Orbit 2: ${talentOrbit.filter(r => r.orbit === 2).map(r => r.name).join(', ') || 'None'}.`,
                missed: () => `Strong candidates (Orbit 3): ${talentOrbit.filter(r => r.orbit === 3).map(r => r.name + ' ‚Äî Fast-track').join(', ') || 'None'}.`
            };

            toggle?.addEventListener('click', () => panel.classList.toggle('open'));
            closeBtn?.addEventListener('click', () => panel.classList.remove('open'));

            const addBotMsg = (text, speak = true) => {
                const div = document.createElement('div');
                div.className = 'hr-chat-msg';
                div.innerHTML = '<div class="bubble">' + text + '</div>';
                messages.appendChild(div);
                messages.scrollTop = messages.scrollHeight;
                
                // Add speak button
                if (typeof addSpeakButton === 'function') {
                    addSpeakButton(div.querySelector('.bubble'), text);
                }
                
                // Auto-speak response
                if (speak && hrVoiceChat) {
                    hrVoiceChat.speak(text);
                }
            };

            if (messages && !messages.innerHTML.trim()) addBotMsg('Hi! I\'m Orion HR Assistant. Ask me about the Talent Orbit, Orbit 3 candidates, or who to fast-track.', false);

            input?.addEventListener('keydown', async (e) => {
                if (e.key !== 'Enter') return;
                const q = input.value.trim();
                if (!q) return;

                const userDiv = document.createElement('div');
                userDiv.className = 'hr-chat-msg user';
                userDiv.innerHTML = '<div class="bubble">' + q + '</div>';
                messages.appendChild(userDiv);
                input.value = '';
                input.disabled = true;
                messages.scrollTop = messages.scrollHeight;

                try {
                    // Use AI chat endpoint for HR
                    const response = await api.sendCandidateMessage(q);
                    addBotMsg(response.response);
                } catch (error) {
                    // Fallback to local responses
                    const qLower = q.toLowerCase();
                let reply = hrResponses.default;
                    if (qLower.includes('summarize') || (qLower.includes('talent') && qLower.includes('role'))) {
                        reply = hrResponses.summarize(q.match(/for\s+([\w\s]+)/i)?.[1]?.trim() || q.match(/(?:satellite|mission|software|developer|engineer|specialist)/i)?.[0] || '');
                    } else if (qLower.includes('almost') || qLower.includes('orbit 2') || qLower.includes('orbit 3')) {
                        reply = hrResponses.almost();
                    } else if (qLower.includes('miss') || qLower.includes('strong') || qLower.includes('fast-track') || qLower.includes('reconsider')) {
                        reply = hrResponses.missed();
                    }
                    addBotMsg(reply);
                } finally {
                    input.disabled = false;
                    input.focus();
                }
            });
        }

        function recontactCandidate(id) {
            const c = talentOrbit.find(r => r.id === id);
            if (c) {
                alert('Re-contact initiated for ' + c.name + '. Fast-track re-entry.');
                // Could trigger notification or update candidate status here
            }
        }

        window.toggleRejectionReason = toggleRejectionReason;
        window.toggleSkillGap = toggleSkillGap;
        window.openReconsiderModal = openReconsiderModal;
        window.recontactCandidate = recontactCandidate;

        function renderJobs() {
            const panels = document.getElementById('jobsPanels');
            if (!panels) return;

            panels.innerHTML = jobs.map(job => `
                <a href="#" class="job-panel" data-job-id="${job.id}" onclick="selectJob('${job.id}'); return false;">
                    <h3>${job.title}</h3>
                    <div class="job-meta">${job.location || 'Not specified'}</div>
                </a>
            `).join('') + '<div class="add-job-btn" id="addJobBtn" title="Add new job">+</div>';

            const addBtn = document.getElementById('addJobBtn');
            if (addBtn) {
                addBtn.addEventListener('click', (e) => {
                e.preventDefault();
                document.getElementById('addJobModal').classList.add('show');
            });
            }
        }

        async function selectJob(id) {
            selectedJobId = id;
            const job = jobs.find(j => j.id === id);
            if (!job) return;
            document.getElementById('jobDetailSection').classList.add('show');
            document.getElementById('jobDetailTitle').textContent = job.title;
            document.getElementById('jobDetailDesc').textContent = job.description || 'No description available.';

            // Populate meta info
            document.getElementById('jobDetailDept').textContent = job.department ? `üìÅ ${job.department}` : '';
            document.getElementById('jobDetailLocation').textContent = job.location ? `üìç ${job.location}` : '';
            document.getElementById('jobDetailWorkType').textContent = job.work_type ? `üè¢ ${job.work_type.charAt(0).toUpperCase() + job.work_type.slice(1)}` : '';

            // Experience
            let expText = '-';
            if (job.experience_min !== null && job.experience_max !== null) {
                expText = `${job.experience_min} - ${job.experience_max} years`;
            } else if (job.experience_min !== null) {
                expText = `${job.experience_min}+ years`;
            }
            document.getElementById('jobDetailExperience').textContent = expText;

            // Salary
            let salaryText = '-';
            if (job.salary_min && job.salary_max) {
                const currency = job.currency || 'AED';
                salaryText = `${currency} ${job.salary_min.toLocaleString()} - ${job.salary_max.toLocaleString()}`;
            }
            document.getElementById('jobDetailSalary').textContent = salaryText;

            // Non-negotiable skills
            const nonNegSkills = job.non_negotiable_skills || [];
            document.getElementById('jobDetailNonNegotiable').innerHTML = nonNegSkills.length > 0
                ? nonNegSkills.map(s => `<span style="background:rgba(239,68,68,0.2);border:1px solid rgba(239,68,68,0.4);padding:0.25rem 0.6rem;border-radius:6px;font-size:0.85rem;">${s}</span>`).join('')
                : '<span style="color:rgba(255,255,255,0.4);">None specified</span>';

            // Preferred skills
            const prefSkills = job.preferred_skills || [];
            document.getElementById('jobDetailPreferred').innerHTML = prefSkills.length > 0
                ? prefSkills.map(s => `<span style="background:rgba(34,197,94,0.2);border:1px solid rgba(34,197,94,0.4);padding:0.25rem 0.6rem;border-radius:6px;font-size:0.85rem;">${s}</span>`).join('')
                : '<span style="color:rgba(255,255,255,0.4);">None specified</span>';

            // Openings
            document.getElementById('jobDetailOpenings').textContent = job.openings_count ? `üìã ${job.openings_count} opening${job.openings_count > 1 ? 's' : ''}` : '';

            document.getElementById('jobDetailSection').scrollIntoView({ behavior: 'smooth' });

            // Load applicants for this job
            await loadJobApplicants(id);
        }

        async function loadJobApplicants(jobId) {
            try {
                const jobApps = await api.request(`/applications?job_role_id=${jobId}`, { requireAuth: true });
                // Store for modal display
                window.currentJobApplicants = jobApps;
            } catch (error) {
                console.error('Failed to load applicants:', error);
                window.currentJobApplicants = [];
            }
        }

        document.getElementById('applicantsBtn').addEventListener('click', async () => {
            if (!selectedJobId) return;
            const job = jobs.find(j => j.id === selectedJobId);

            try {
                const jobApps = await api.request(`/applications?job_role_id=${selectedJobId}`, {
                    requireAuth: true,
                    method: 'GET'
                });
                
                console.log('Loaded applications:', jobApps);
                
                // Sort by combined_score or technical_score
                jobApps.sort((a, b) => (b.combined_score || b.technical_score || 0) - (a.combined_score || a.technical_score || 0));

            document.getElementById('applicantsModalTitle').textContent = `Applicants ‚Äî ${job ? job.title : 'Position'}`;

                if (jobApps.length === 0) {
                    document.getElementById('applicantsList').innerHTML = '<p style="color: rgba(255,255,255,0.6);">No applicants yet.</p>';
                    document.getElementById('topNControls').style.display = 'none';
                    currentApplicantsList = [];
                } else {
                    document.getElementById('topNControls').style.display = 'flex';
                    // Load candidate details for each application
                    const applicantsWithDetails = await Promise.all(jobApps.map(async (app, i) => {
                        try {
                            const candidate = await api.getCandidate(app.candidate_id);
                            return {
                                ...app,
                                name: `${candidate.first_name} ${candidate.last_name}`,
                                email: candidate.email,
                                rank: i + 1,
                                score: app.combined_score || app.technical_score || 0
                            };
                        } catch (err) {
                            return {
                                ...app,
                                name: 'Unknown',
                                email: 'N/A',
                                rank: i + 1,
                                score: app.combined_score || app.technical_score || 0
                            };
                        }
                    }));

                    // Store for bulk actions
                    currentApplicantsList = applicantsWithDetails;
                    
                    // Update the max value of the input
                    document.getElementById('topNInput').max = applicantsWithDetails.length;
                    if (parseInt(document.getElementById('topNInput').value) > applicantsWithDetails.length) {
                        document.getElementById('topNInput').value = applicantsWithDetails.length;
                    }

                    document.getElementById('applicantsList').innerHTML = applicantsWithDetails.map(a => `
                        <div class="applicant-card" style="position: relative; padding: 1.25rem; background: rgba(15, 23, 42, 0.8); border: 1px solid rgba(59, 130, 246, 0.3); border-radius: 1rem; margin-bottom: 1rem;">
                            <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;">
                                <span class="applicant-rank" style="background: linear-gradient(135deg, #3b82f6, #8b5cf6); color: white; padding: 0.5rem 0.75rem; border-radius: 0.5rem; font-weight: 700; font-size: 0.9rem;">#${a.rank}</span>
                                <div style="flex: 1;">
                                    <h4 style="margin: 0; font-size: 1.1rem;">${a.name}</h4>
                                    <div class="applicant-email" style="color: rgba(255,255,255,0.6); font-size: 0.85rem;">${a.email}</div>
                </div>
                                <div style="text-align: right;">
                                    <div style="font-size: 1.5rem; font-weight: 700; color: ${a.score >= 70 ? '#22c55e' : a.score >= 50 ? '#f59e0b' : '#ef4444'};">${Math.round(a.score)}%</div>
                                    <div style="font-size: 0.75rem; color: rgba(255,255,255,0.5);">Combined</div>
                                </div>
                            </div>
                            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.75rem; margin-bottom: 1rem;">
                                <div style="background: rgba(59, 130, 246, 0.1); border: 1px solid rgba(59, 130, 246, 0.3); border-radius: 0.5rem; padding: 0.75rem; text-align: center;">
                                    <div style="font-size: 1.1rem; font-weight: 600; color: #60a5fa;">${a.technical_score !== null && a.technical_score !== undefined ? Math.round(a.technical_score) + '%' : 'N/A'}</div>
                                    <div style="font-size: 0.7rem; color: rgba(255,255,255,0.5);">Technical</div>
                                </div>
                                <div style="background: rgba(139, 92, 246, 0.1); border: 1px solid rgba(139, 92, 246, 0.3); border-radius: 0.5rem; padding: 0.75rem; text-align: center; cursor: pointer;" onclick="toggleBehavioralDetails('${a.id}')">
                                    <div style="font-size: 1.1rem; font-weight: 600; color: #a78bfa;">${a.behavioral_score !== null && a.behavioral_score !== undefined ? Math.round(a.behavioral_score) + '%' : '<span style="font-size:0.8rem;">Pending</span>'}</div>
                                    <div style="font-size: 0.7rem; color: rgba(255,255,255,0.5);">Behavioral ${a.behavioral_score !== null ? '‚ñº' : ''}</div>
                                </div>
                                <div style="background: rgba(34, 197, 94, 0.1); border: 1px solid rgba(34, 197, 94, 0.3); border-radius: 0.5rem; padding: 0.75rem; text-align: center;">
                                    <div style="font-size: 0.85rem; font-weight: 500; color: ${a.eligibility_check_passed ? '#22c55e' : '#ef4444'};">${a.eligibility_check_passed ? '‚úì Eligible' : '‚úó Ineligible'}</div>
                                    <div style="font-size: 0.7rem; color: rgba(255,255,255,0.5);">Skills Check</div>
                                </div>
                            </div>
                            
                            <!-- Behavioral Feedback Details (hidden by default) -->
                            <div id="behavioral-details-${a.id}" style="display: none; margin-bottom: 1rem; padding: 1rem; background: rgba(139, 92, 246, 0.05); border: 1px solid rgba(139, 92, 246, 0.2); border-radius: 0.75rem;">
                                <div style="font-size: 0.8rem; font-weight: 600; color: #a78bfa; margin-bottom: 0.75rem;">Behavioral Assessment Breakdown</div>
                                <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 0.5rem; margin-bottom: 0.75rem;">
                                    <div style="text-align: center; padding: 0.5rem; background: rgba(255,255,255,0.05); border-radius: 0.5rem;">
                                        <div style="font-size: 0.9rem; font-weight: 600; color: #60a5fa;">${a.parameter_scores?.problem_solving || '--'}%</div>
                                        <div style="font-size: 0.65rem; color: rgba(255,255,255,0.5);">Problem Solving</div>
                                    </div>
                                    <div style="text-align: center; padding: 0.5rem; background: rgba(255,255,255,0.05); border-radius: 0.5rem;">
                                        <div style="font-size: 0.9rem; font-weight: 600; color: #22c55e;">${a.parameter_scores?.communication || '--'}%</div>
                                        <div style="font-size: 0.65rem; color: rgba(255,255,255,0.5);">Communication</div>
                                    </div>
                                    <div style="text-align: center; padding: 0.5rem; background: rgba(255,255,255,0.05); border-radius: 0.5rem;">
                                        <div style="font-size: 0.9rem; font-weight: 600; color: #f59e0b;">${a.parameter_scores?.teamwork || '--'}%</div>
                                        <div style="font-size: 0.65rem; color: rgba(255,255,255,0.5);">Teamwork</div>
                                    </div>
                                    <div style="text-align: center; padding: 0.5rem; background: rgba(255,255,255,0.05); border-radius: 0.5rem;">
                                        <div style="font-size: 0.9rem; font-weight: 600; color: #ec4899;">${a.parameter_scores?.adaptability || '--'}%</div>
                                        <div style="font-size: 0.65rem; color: rgba(255,255,255,0.5);">Adaptability</div>
                                    </div>
                                    <div style="text-align: center; padding: 0.5rem; background: rgba(255,255,255,0.05); border-radius: 0.5rem;">
                                        <div style="font-size: 0.9rem; font-weight: 600; color: #8b5cf6;">${a.parameter_scores?.leadership || '--'}%</div>
                                        <div style="font-size: 0.65rem; color: rgba(255,255,255,0.5);">Leadership</div>
                                    </div>
                                </div>
                                ${a.feedback_summary ? `<div style="font-size: 0.85rem; color: #d1d5db; line-height: 1.5; padding: 0.75rem; background: rgba(0,0,0,0.2); border-radius: 0.5rem;"><strong style="color: #a78bfa;">AI Summary:</strong> ${a.feedback_summary}</div>` : ''}
                            </div>
                            
                            <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 0.5rem;">
                                <span style="padding: 0.25rem 0.75rem; border-radius: 1rem; font-size: 0.8rem; background: ${a.status === 'applied' ? 'rgba(59,130,246,0.2)' : a.status === 'shortlisted' ? 'rgba(34,197,94,0.2)' : a.status === 'interview_scheduled' ? 'rgba(251,191,36,0.2)' : a.status === 'rejected' ? 'rgba(239,68,68,0.2)' : 'rgba(255,255,255,0.1)'}; color: ${a.status === 'applied' ? '#60a5fa' : a.status === 'shortlisted' ? '#22c55e' : a.status === 'interview_scheduled' ? '#fbbf24' : a.status === 'rejected' ? '#ef4444' : 'rgba(255,255,255,0.7)'};">
                                    ${a.status.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase())}
                                </span>
                                <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                                    <button onclick="openNotesModal('${a.id}', '${a.name.replace(/'/g, "\\'")}', '${a.email}')" style="padding: 0.4rem 0.8rem; background: rgba(139,92,246,0.2); border: 1px solid rgba(139,92,246,0.4); color: #a78bfa; border-radius: 0.4rem; cursor: pointer; font-size: 0.8rem;">üìù Notes</button>
                                    <button onclick="scheduleInterview('${a.id}', '${a.name.replace(/'/g, "\\'")}', '${a.email}')" style="padding: 0.4rem 0.8rem; background: rgba(251,191,36,0.2); border: 1px solid rgba(251,191,36,0.4); color: #fbbf24; border-radius: 0.4rem; cursor: pointer; font-size: 0.8rem;" ${a.status === 'rejected' ? 'disabled style="opacity:0.5;cursor:not-allowed;"' : ''}>üìÖ Interview</button>
                                    <button onclick="updateApplicationStatus('${a.id}', 'shortlisted')" style="padding: 0.4rem 0.8rem; background: rgba(34,197,94,0.2); border: 1px solid rgba(34,197,94,0.4); color: #22c55e; border-radius: 0.4rem; cursor: pointer; font-size: 0.8rem;" ${a.status === 'shortlisted' || a.status === 'rejected' ? 'disabled style="opacity:0.5;cursor:not-allowed;"' : ''}>Shortlist</button>
                                    <button onclick="updateApplicationStatus('${a.id}', 'rejected')" style="padding: 0.4rem 0.8rem; background: rgba(239,68,68,0.2); border: 1px solid rgba(239,68,68,0.4); color: #ef4444; border-radius: 0.4rem; cursor: pointer; font-size: 0.8rem;" ${a.status === 'rejected' ? 'disabled style="opacity:0.5;cursor:not-allowed;"' : ''}>Reject</button>
                                </div>
                            </div>
                        </div>
                    `).join('');
                }
            document.getElementById('applicantsModal').classList.add('show');
            } catch (error) {
                alert('Failed to load applicants: ' + error.message);
            }
        });

        document.getElementById('applicantsModalClose').addEventListener('click', () => {
            document.getElementById('applicantsModal').classList.remove('show');
        });

        // Store current applicants for bulk actions
        let currentApplicantsList = [];

        // Shortlist Top N candidates
        document.getElementById('shortlistTopNBtn').addEventListener('click', async () => {
            const topN = parseInt(document.getElementById('topNInput').value) || 3;
            const toShortlist = currentApplicantsList.slice(0, topN).filter(a => a.status !== 'shortlisted' && a.status !== 'rejected');
            
            if (toShortlist.length === 0) {
                alert('No candidates to shortlist (they may already be shortlisted or rejected)');
                return;
            }
            
            if (!confirm(`Shortlist the top ${toShortlist.length} candidate(s)?`)) return;
            
            const btn = document.getElementById('shortlistTopNBtn');
            btn.textContent = 'Processing...';
            btn.disabled = true;
            
            try {
                for (const app of toShortlist) {
                    await api.updateApplicationStatus(app.id, 'shortlisted');
                }
                alert(`Successfully shortlisted ${toShortlist.length} candidate(s)!`);
                document.getElementById('applicantsBtn').click(); // Refresh
            } catch (error) {
                alert('Error: ' + error.message);
            } finally {
                btn.textContent = '‚úì Shortlist Top';
                btn.disabled = false;
            }
        });

        // Reject candidates not in top N
        document.getElementById('rejectRestBtn').addEventListener('click', async () => {
            const topN = parseInt(document.getElementById('topNInput').value) || 3;
            const toReject = currentApplicantsList.slice(topN).filter(a => a.status !== 'rejected' && a.status !== 'shortlisted');
            
            if (toReject.length === 0) {
                alert('No candidates to reject (they may already be processed)');
                return;
            }
            
            if (!confirm(`Reject ${toReject.length} candidate(s) ranked below top ${topN}?`)) return;
            
            const btn = document.getElementById('rejectRestBtn');
            btn.textContent = 'Processing...';
            btn.disabled = true;
            
            try {
                for (const app of toReject) {
                    await api.updateApplicationStatus(app.id, 'rejected');
                }
                alert(`Rejected ${toReject.length} candidate(s)`);
                document.getElementById('applicantsBtn').click(); // Refresh
            } catch (error) {
                alert('Error: ' + error.message);
            } finally {
                btn.textContent = '‚úó Reject Others';
                btn.disabled = false;
            }
        });

        // Update application status (shortlist/reject)
        async function updateApplicationStatus(applicationId, newStatus) {
            try {
                await api.updateApplicationStatus(applicationId, newStatus);
                // Refresh the applicants list
                document.getElementById('applicantsBtn').click();
            } catch (error) {
                alert('Failed to update status: ' + error.message);
            }
        }

        // Toggle behavioral details visibility
        function toggleBehavioralDetails(applicationId) {
            const details = document.getElementById(`behavioral-details-${applicationId}`);
            if (details) {
                details.style.display = details.style.display === 'none' ? 'block' : 'none';
            }
        }

        // ============ HR NOTES FUNCTIONALITY ============
        
        let currentNotesApplicationId = null;
        let currentNotesCandidate = { name: '', email: '' };

        async function openNotesModal(applicationId, candidateName, candidateEmail) {
            currentNotesApplicationId = applicationId;
            currentNotesCandidate = { name: candidateName, email: candidateEmail };
            
            document.getElementById('notesCandidateName').textContent = candidateName;
            document.getElementById('notesCandidateEmail').textContent = candidateEmail;
            document.getElementById('notesModalTitle').textContent = `Interview Notes ‚Äî ${candidateName}`;
            
            // Reset form
            document.getElementById('addNoteForm').reset();
            
            // Load existing notes
            await loadExistingNotes(applicationId);
            
            document.getElementById('notesModal').classList.add('show');
        }

        async function loadExistingNotes(applicationId) {
            const container = document.getElementById('existingNotes');
            container.innerHTML = '<p style="color: rgba(255,255,255,0.5); font-size: 0.9rem;">Loading notes...</p>';
            
            try {
                const notes = await api.getApplicationFeedback(applicationId);
                
                if (notes.length === 0) {
                    container.innerHTML = '<p style="color: rgba(255,255,255,0.5); font-size: 0.9rem; text-align: center; padding: 1rem;">No notes yet. Add your first note below.</p>';
                    return;
                }
                
                container.innerHTML = notes.map(note => `
                    <div class="note-card" style="padding: 1rem; background: rgba(15, 23, 42, 0.6); border: 1px solid rgba(139, 92, 246, 0.2); border-radius: 0.75rem; margin-bottom: 0.75rem;">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.75rem;">
                            <div>
                                <span style="color: #a78bfa; font-weight: 600; font-size: 0.85rem;">${note.feedback_type ? note.feedback_type.replace(/\b\w/g, l => l.toUpperCase()) : 'Note'}</span>
                                <span style="color: rgba(255,255,255,0.4); font-size: 0.75rem; margin-left: 0.5rem;">${note.created_at ? new Date(note.created_at).toLocaleDateString() : ''}</span>
                            </div>
                            ${note.role_fit_score ? `<span style="background: ${note.role_fit_score >= 7 ? 'rgba(34,197,94,0.2)' : note.role_fit_score >= 5 ? 'rgba(251,191,36,0.2)' : 'rgba(239,68,68,0.2)'}; color: ${note.role_fit_score >= 7 ? '#22c55e' : note.role_fit_score >= 5 ? '#fbbf24' : '#ef4444'}; padding: 0.25rem 0.5rem; border-radius: 0.25rem; font-size: 0.8rem; font-weight: 600;">${note.role_fit_score}/10</span>` : ''}
                        </div>
                        ${note.strengths ? `<div style="margin-bottom: 0.5rem;"><span style="color: #22c55e; font-size: 0.75rem; font-weight: 500;">‚úì Strengths:</span> <span style="color: rgba(255,255,255,0.8); font-size: 0.85rem;">${note.strengths}</span></div>` : ''}
                        ${note.weaknesses ? `<div style="margin-bottom: 0.5rem;"><span style="color: #f59e0b; font-size: 0.75rem; font-weight: 500;">‚ö† Weaknesses:</span> <span style="color: rgba(255,255,255,0.8); font-size: 0.85rem;">${note.weaknesses}</span></div>` : ''}
                        ${note.missing_requirements ? `<div style="margin-bottom: 0.5rem;"><span style="color: #ef4444; font-size: 0.75rem; font-weight: 500;">‚úó Missing:</span> <span style="color: rgba(255,255,255,0.8); font-size: 0.85rem;">${note.missing_requirements}</span></div>` : ''}
                        ${note.recommendation ? `<div style="margin-bottom: 0.5rem;"><span style="color: #60a5fa; font-size: 0.75rem; font-weight: 500;">Recommendation:</span> <span style="color: ${note.recommendation === 'hire' ? '#22c55e' : note.recommendation === 'reject' ? '#ef4444' : '#fbbf24'}; font-size: 0.85rem; font-weight: 500;">${note.recommendation.replace(/\b\w/g, l => l.toUpperCase())}</span></div>` : ''}
                        ${note.additional_notes ? `<div style="color: rgba(255,255,255,0.7); font-size: 0.85rem; padding-top: 0.5rem; border-top: 1px solid rgba(255,255,255,0.1);">${note.additional_notes}</div>` : ''}
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 0.5rem; padding-top: 0.5rem; border-top: 1px solid rgba(255,255,255,0.05);">
                            <span style="color: rgba(255,255,255,0.4); font-size: 0.75rem;">By: ${note.hr_user_name || 'HR Team'}</span>
                            <button onclick="deleteNote('${note.id}')" style="background: none; border: none; color: rgba(239,68,68,0.7); font-size: 0.75rem; cursor: pointer;">Delete</button>
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                container.innerHTML = '<p style="color: #ef4444; font-size: 0.9rem;">Failed to load notes: ' + error.message + '</p>';
            }
        }

        async function deleteNote(noteId) {
            if (!confirm('Delete this note?')) return;
            
            try {
                await api.deleteFeedback(noteId);
                await loadExistingNotes(currentNotesApplicationId);
            } catch (error) {
                alert('Failed to delete note: ' + error.message);
            }
        }

        // Notes modal close
        document.getElementById('notesModalClose')?.addEventListener('click', () => {
            document.getElementById('notesModal').classList.remove('show');
        });
        
        document.getElementById('cancelNoteBtn')?.addEventListener('click', () => {
            document.getElementById('notesModal').classList.remove('show');
        });

        // Add note form submission
        document.getElementById('addNoteForm')?.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const feedbackData = {
                feedback_type: document.getElementById('noteFeedbackType').value,
                role_fit_score: document.getElementById('noteRoleFitScore').value ? parseInt(document.getElementById('noteRoleFitScore').value) : null,
                strengths: document.getElementById('noteStrengths').value.trim() || null,
                weaknesses: document.getElementById('noteWeaknesses').value.trim() || null,
                missing_requirements: document.getElementById('noteMissingReqs').value.trim() || null,
                recommendation: document.getElementById('noteRecommendation').value || null,
                additional_notes: document.getElementById('noteAdditional').value.trim() || null
            };
            
            // Require at least one field
            if (!feedbackData.strengths && !feedbackData.weaknesses && !feedbackData.missing_requirements && !feedbackData.additional_notes) {
                alert('Please fill in at least one field (strengths, weaknesses, missing requirements, or additional notes).');
                return;
            }
            
            const submitBtn = e.target.querySelector('button[type="submit"]');
            submitBtn.textContent = 'Saving...';
            submitBtn.disabled = true;
            
            try {
                await api.createFeedback(currentNotesApplicationId, feedbackData);
                document.getElementById('addNoteForm').reset();
                await loadExistingNotes(currentNotesApplicationId);
                alert('Note saved! This feedback will be used in rejection emails if applicable.');
            } catch (error) {
                alert('Failed to save note: ' + error.message);
            } finally {
                submitBtn.textContent = 'Save Note';
                submitBtn.disabled = false;
            }
        });

        // ============ END HR NOTES ============

        // Scheduled interviews storage (in production, this would be from backend)
        let scheduledInterviews = JSON.parse(localStorage.getItem('scheduledInterviews') || '[]');

        // Schedule interview modal
        async function scheduleInterview(applicationId, candidateName, candidateEmail) {
            const interviewDate = prompt(`Schedule interview for ${candidateName}\n\nEnter date and time (e.g., 2026-02-15 14:00):`);
            if (!interviewDate) return;

            const interviewType = prompt('Interview type:\n1. Video Call\n2. Phone Call\n3. In-Person\n\nEnter 1, 2, or 3:', '1');
            const types = { '1': 'Video Call', '2': 'Phone Call', '3': 'In-Person' };
            const selectedType = types[interviewType] || 'Video Call';

            const interviewer = prompt('Interviewer name(s):', 'HR Team');
            if (!interviewer) return;

            const meetingLink = selectedType === 'Video Call' ? prompt('Meeting link (optional):', 'https://meet.google.com/') : '';

            try {
                // Schedule via API
                await api.scheduleInterview(applicationId, interviewDate, selectedType, interviewer, meetingLink || null);
                
                // Also save locally for the interviews tab
                const interview = {
                    id: Date.now().toString(),
                    applicationId,
                    candidateName,
                    candidateEmail,
                    scheduledAt: interviewDate,
                    type: selectedType,
                    interviewer,
                    meetingLink,
                    status: 'scheduled',
                    createdAt: new Date().toISOString()
                };

                scheduledInterviews.push(interview);
                localStorage.setItem('scheduledInterviews', JSON.stringify(scheduledInterviews));

                alert(`Interview scheduled for ${candidateName} on ${interviewDate}`);
                
                // Refresh the applicants list to show updated status
                document.getElementById('applicantsBtn').click();
                refreshInterviews();
            } catch (error) {
                alert('Failed to schedule interview: ' + error.message);
            }
        }

        // Refresh interviews list
        function refreshInterviews() {
            scheduledInterviews = JSON.parse(localStorage.getItem('scheduledInterviews') || '[]');
            
            const now = new Date();
            const today = now.toDateString();
            const weekEnd = new Date(now.getTime() + 7 * 24 * 60 * 60 * 1000);

            // Calculate stats
            let todayCount = 0, weekCount = 0, completedCount = 0, pendingCount = 0;
            
            scheduledInterviews.forEach(i => {
                const iDate = new Date(i.scheduledAt);
                if (i.status === 'completed') completedCount++;
                else {
                    pendingCount++;
                    if (iDate.toDateString() === today) todayCount++;
                    if (iDate <= weekEnd) weekCount++;
                }
            });

            document.getElementById('interviewsToday').textContent = todayCount;
            document.getElementById('interviewsThisWeek').textContent = weekCount;
            document.getElementById('interviewsCompleted').textContent = completedCount;
            document.getElementById('interviewsPending').textContent = pendingCount;

            // Render interviews list
            const list = document.getElementById('interviewsList');
            const upcoming = scheduledInterviews
                .filter(i => i.status !== 'completed')
                .sort((a, b) => new Date(a.scheduledAt) - new Date(b.scheduledAt));

            if (upcoming.length === 0) {
                list.innerHTML = `
                    <div style="text-align: center; padding: 2rem; color: rgba(255,255,255,0.5);">
                        <div style="font-size: 2rem; margin-bottom: 0.5rem;">üìÖ</div>
                        <p>No interviews scheduled yet.</p>
                        <p style="font-size: 0.85rem;">Schedule interviews from the applicant cards in Open Positions.</p>
                    </div>
                `;
                return;
            }

            list.innerHTML = upcoming.map(i => {
                const interviewDate = new Date(i.scheduledAt);
                const isPast = interviewDate < now;
                
                return `
                    <div style="display: flex; align-items: center; gap: 1rem; padding: 1rem; background: ${isPast ? 'rgba(239, 68, 68, 0.1)' : 'rgba(255,255,255,0.03)'}; border: 1px solid ${isPast ? 'rgba(239, 68, 68, 0.3)' : 'rgba(255,255,255,0.1)'}; border-radius: 0.75rem; margin-bottom: 0.75rem;">
                        <div style="width: 60px; text-align: center; flex-shrink: 0;">
                            <div style="font-size: 1.5rem; font-weight: 700; color: ${isPast ? '#ef4444' : '#60a5fa'};">${interviewDate.getDate()}</div>
                            <div style="font-size: 0.75rem; color: rgba(255,255,255,0.5);">${interviewDate.toLocaleString('en-US', { month: 'short' })}</div>
                        </div>
                        <div style="flex: 1;">
                            <div style="font-weight: 600; color: #f3f4f6; margin-bottom: 0.25rem;">${i.candidateName}</div>
                            <div style="font-size: 0.85rem; color: rgba(255,255,255,0.6);">${i.type} ‚Ä¢ ${interviewDate.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' })}</div>
                            <div style="font-size: 0.8rem; color: rgba(255,255,255,0.5);">With: ${i.interviewer}</div>
                        </div>
                        <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                            ${i.meetingLink ? `<a href="${i.meetingLink}" target="_blank" style="padding: 0.4rem 0.8rem; background: rgba(59,130,246,0.2); border: 1px solid rgba(59,130,246,0.4); color: #60a5fa; border-radius: 0.4rem; text-decoration: none; font-size: 0.8rem;">Join</a>` : ''}
                            <button onclick="markInterviewComplete('${i.id}')" style="padding: 0.4rem 0.8rem; background: rgba(34,197,94,0.2); border: 1px solid rgba(34,197,94,0.4); color: #22c55e; border-radius: 0.4rem; cursor: pointer; font-size: 0.8rem;">‚úì Done</button>
                            <button onclick="cancelInterview('${i.id}')" style="padding: 0.4rem 0.8rem; background: rgba(239,68,68,0.2); border: 1px solid rgba(239,68,68,0.4); color: #ef4444; border-radius: 0.4rem; cursor: pointer; font-size: 0.8rem;">Cancel</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Mark interview as complete
        function markInterviewComplete(interviewId) {
            scheduledInterviews = scheduledInterviews.map(i => 
                i.id === interviewId ? {...i, status: 'completed'} : i
            );
            localStorage.setItem('scheduledInterviews', JSON.stringify(scheduledInterviews));
            refreshInterviews();
        }

        // Cancel interview
        function cancelInterview(interviewId) {
            if (!confirm('Cancel this interview?')) return;
            scheduledInterviews = scheduledInterviews.filter(i => i.id !== interviewId);
            localStorage.setItem('scheduledInterviews', JSON.stringify(scheduledInterviews));
            refreshInterviews();
        }

        // Load interviews on page load
        document.addEventListener('DOMContentLoaded', () => {
            refreshInterviews();
        });

        document.getElementById('addJobModalClose').addEventListener('click', () => {
            document.getElementById('addJobModal').classList.remove('show');
        });

        document.getElementById('addJobCancel').addEventListener('click', () => {
            document.getElementById('addJobModal').classList.remove('show');
        });

        document.getElementById('addJobForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const title = document.getElementById('newJobTitle').value.trim();
            const department = document.getElementById('newJobDepartment').value.trim();
            const location = document.getElementById('newJobLocation').value.trim();
            const desc = document.getElementById('newJobDesc').value.trim();
            const nonNegotiable = document.getElementById('newJobNonNegotiable').value.trim();
            const preferred = document.getElementById('newJobPreferred').value.trim();

            if (!title) {
                alert('Job title is required');
                return;
            }
            if (!department) {
                alert('Department is required');
                return;
            }

            // Parse comma-separated skills into arrays
            const nonNegotiableSkills = nonNegotiable ? nonNegotiable.split(',').map(s => s.trim()).filter(s => s) : [];
            const preferredSkills = preferred ? preferred.split(',').map(s => s.trim()).filter(s => s) : [];

            const submitBtn = e.target.querySelector('button[type="submit"]');
            const originalText = submitBtn.textContent;
            submitBtn.textContent = 'Creating...';
            submitBtn.disabled = true;

            try {
                const newJob = await api.request('/jobs', {
                    method: 'POST',
                    requireAuth: true,
                    body: JSON.stringify({
                        title: title,
                        department: department,
                        description: desc || 'No description provided.',
                        location: location || null,
                        work_type: 'onsite',
                        non_negotiable_skills: nonNegotiableSkills,
                        preferred_skills: preferredSkills,
                        is_active: true
                    })
                });
            jobs.push(newJob);
            document.getElementById('addJobForm').reset();
            document.getElementById('addJobModal').classList.remove('show');
            renderJobs();
            } catch (error) {
                alert('Failed to create job: ' + error.message);
                submitBtn.textContent = originalText;
                submitBtn.disabled = false;
            }
        });

        document.querySelectorAll('.modal-overlay').forEach(overlay => {
            overlay.addEventListener('click', (e) => {
                if (e.target === overlay) overlay.classList.remove('show');
            });
        });

        window.selectJob = selectJob;
    </script>
</body>

</html>